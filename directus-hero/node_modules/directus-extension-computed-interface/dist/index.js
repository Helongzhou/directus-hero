import{useStores as e,useApi as t,useCollection as r,defineInterface as n}from"@directus/extensions-sdk";import{ref as i,computed as l,watch as u,defineComponent as a,inject as o,resolveComponent as s,openBlock as f,createElementBlock as c,Fragment as d,normalizeStyle as p,createElementVNode as m,toDisplayString as g,createBlock as y,mergeProps as v,withCtx as S,createTextVNode as T,createCommentVNode as E}from"vue";function N(e,t){return(e.match(/{{.*?}}/g)||[]).some((e=>e.includes(t)))}const h=(r,n,a,o,s,f)=>{const c=t(),{currentUser:d}=e().useUserStore(),p=i({});let m={},g={};const y=l((()=>JSON.stringify(r.value,((e,t)=>void 0===t?null:t))));return u(y,(async(e,t)=>{var r,i,l;const u=JSON.parse(e),y=void 0!==t?JSON.parse(t):{};if(!function(e,t,r,n,i){if(r.id&&"+"===i)return!1;for(const i of Object.keys({...n,...r}))if(i!==t&&N(e,i)&&r[i]!==n[i]&&JSON.stringify(r[i])!==JSON.stringify(n[i]))return!0;return!1}(f,o,u,y,s))return;for(const e of Object.keys(y))e in u||(u[e]=null);let v={};const S=u.id||s;for(const e of Object.keys(u)){const t=n.value.find((t=>{var r,n;return[null===(r=t.meta)||void 0===r?void 0:r.one_field,null===(n=t.meta)||void 0===n?void 0:n.many_field].includes(e)}));if(!t||!N(f,e))continue;const o=t.collection===a;let s=null!==(l=u[o?null===(r=t.meta)||void 0===r?void 0:r.many_field:null===(i=t.meta)||void 0===i?void 0:i.one_field])&&void 0!==l?l:{create:[],update:[],delete:[]},d=[],p=[];if(o)"number"==typeof s||"string"==typeof s?(s={update:[{id:s}]},"object"==typeof y[e]&&(m={},g={})):"object"==typeof s&&(s="id"in s?{update:[s]}:{create:[{...s}]});else{if(s instanceof Array&&!(y[e]instanceof Array)&&(m={},g={}),"+"!==S){let t;e in m?t=m[e]:(t=(await c.get(`items/${a}/${S}`,{params:{fields:[e]}})).data.data[e],m[e]=t),d=d.concat(t)}if(s.update){const e=s.update.map((({id:e})=>e));d=d.filter((t=>!e.includes(t)))}s.delete&&(d=d.filter((e=>!s.delete.includes(e))))}if(s.update&&(d=d.concat(s.update.map((({id:e})=>e)))),d.length){const e=o?t.related_collection:t.collection,r="directus_users"===e?"/users":`items/${e}`;if(e){let t;t=e in g&&d.every((t=>t in g[e]))?d.map((t=>g[e][t])):(await c.get(r,{params:{filter:{id:{_in:d}}}})).data.data,p=t.map((t=>{var r;return e in g?g[e][t.id]=t:g[e]={[t.id]:t},{...t,...null===(r=s.update)||void 0===r?void 0:r.find((({id:e})=>t.id===e))}}))}}s.create&&(p=p.concat(s.create)),v[e]=o?p[0]:p}p.value={...u,...v,__currentUser:d}}),{deep:!1,immediate:!0}),p},R=(e,t)=>{let r=e;for(const e of t.split(".")){if(!(e in r))return{value:null,found:!1};r=r[e]}return{value:r,found:!0}};function U(e,t,r={}){var n,i,l;if(t){e=e.trim();let{value:u,found:a}=R(t,e);if(!a||null===u){let t=R(r,e);if(t.found)return t.value}if(a)return u;if("$NOW"===e)return new Date;if(e.startsWith("$CURRENT_USER"))return"$CURRENT_USER"===e?null===(n=t.__currentUser)||void 0===n?void 0:n.id:R({$CURRENT_USER:t.__currentUser},e).value;const o=function(e){const t=e.match(/^([A-Z_]+)\((.+)\)$/);if(t){const e=[],r=t[1],n=t[2];let i=0,l=0,u=0;for(;l<n.length;l+=1){const t=n[l];"("===t&&(i+=1),")"===t&&(i-=1),","===t&&0===i&&(e.push(n.slice(u,l)),u=l+1)}return u<l&&e.push(n.slice(u,l)),{op:r,args:e}}return null}(e);if(o){const{op:e,args:n}=o;if(1===n.length){const i=U(n[0],t,r);if("INT"===e)return parseInt(i);if("FLOAT"===e)return parseFloat(i);if("STRING"===e)return String(i);if("DATE"===e)return new Date(i);if("SLUG"===e)return function(e){if("string"!=typeof e)return"";let t=e.replace(/^\s+|\s+$/g,"");t=t.toLowerCase();const r="àáãảạăằắẳẵặâầấẩẫậèéẻẽẹêềếểễệđùúủũụưừứửữựòóỏõọôồốổỗộơờớởỡợìíỉĩịäëïîöüûñçýỳỹỵỷ",n="aaaaaaaaaaaaaaaaaeeeeeeeeeeeduuuuuuuuuuuoooooooooooooooooiiiiiaeiiouuncyyyyy";for(let e=0,i=r.length;e<i;e++)t=t.replace(new RegExp(r.charAt(e),"g"),n.charAt(e));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),t}(i);if("CURRENCY"===e)return(new Intl.NumberFormat).format(i);if("DATE_ISO"===e)return new Date(i).toISOString();if("DATE_UTC"===e)return new Date(i).toUTCString();if(["YEAR","MONTH","GET_DATE","DAY","HOURS","MINUTES","SECONDS","TIME"].includes(e)){if(i instanceof Date){return i[{YEAR:"getFullYear",MONTH:"getMonth",GET_DATE:"getDate",DAY:"getDay",HOURS:"getHours",MINUTES:"getMinutes",SECONDS:"getSeconds",TIME:"getTime"}[e]]()}return 0}if("ABS"===e)return Math.abs(i);if("SQRT"===e)return Math.sqrt(i);if("SUM"===e)return i instanceof Array?i.reduce(((e,t)=>e+t),0):0;if("AVERAGE"===e)return i instanceof Array?i.reduce(((e,t)=>e+t),0)/i.length:0;if("NULL"===e)return null===i;if("NOT_NULL"===e)return null!==i;if("NOT"===e)return!i;if("STR_LEN"===e)return String(i).length;if("LOWER"===e)return String(i).toLowerCase();if("UPPER"===e)return String(i).toUpperCase();if("TRIM"===e)return String(i).trim();if("ARRAY_LEN"===e)return i instanceof Array?i.length:0}else{if("ASUM"===e&&2===n.length)return null!==(l=null===(i=t[n[0]])||void 0===i?void 0:i.reduce(((e,t)=>e+U(n[1],t,{})),0))&&void 0!==l?l:0;if(2===n.length){const i=U(n[0],t,r),l=U(n[1],t,r);if("SUM"===e)return i+l;if("SUBTRACT"===e)return i-l;if("MULTIPLY"===e)return i*l;if("DIVIDE"===e)return i/l;if("REMAINDER"===e)return i%l;if("ROUND"===e)return i.toFixed(l);if("MAX"===e)return Math.max(i,l);if("MIN"===e)return Math.min(i,l);if("POWER"===e)return Math.pow(i,l);if("CONCAT"===e)return String(i)+String(l);if("LEFT"===e)return String(i).slice(0,Number(l));if("RIGHT"===e)return String(i).slice(-Number(l));if("EQUAL"===e)return i===l;if("NOT_EQUAL"===e)return i!==l;if("GT"===e)return i>l;if("GTE"===e)return i>=l;if("LT"===e)return i<l;if("LTE"===e)return i<=l;if("AND"===e)return i&&l;if("OR"===e)return i||l}else if(3===n.length&&"IF"===e)return!0===U(n[0],t,r)?U(n[1],t,r):U(n[2],t,r)}}if(!isNaN(parseFloat(e)))return parseFloat(e);throw new Error(`Cannot parse expression: ${e}`)}return""}var A=a({props:{value:{type:[String,Number],default:null},field:{type:String,default:null},type:{type:String,default:null},collection:{type:String,default:""},primaryKey:{type:[String,Number],default:""},template:{type:String,default:""},mode:{type:String,default:null},prefix:{type:String,default:null},suffix:{type:String,default:null},customCss:{type:Object,default:null}},emits:["input"],setup(t,{emit:n}){const l=r(t.collection).defaults,a=i(t.value),s=(t=>{const{useRelationsStore:r}=e(),{getRelationsForCollection:n}=r();return i(n(t))})(t.collection),f=h(o("values"),s,t.collection,t.field,t.primaryKey,t.template),c=i(null);return f&&u(f,(()=>{const e=function(){var e;try{const e=t.template.replace(/{{.*?}}/g,(e=>U(e.slice(2,-2).trim(),f.value,l.value)));return c.value=null,["integer","decimal","bigInteger"].includes(t.type)?parseInt(e)||0:["float"].includes(t.type)?parseFloat(e)||0:e}catch(t){return c.value=null!==(e=t.message)&&void 0!==e?e:"Unknown error",null}}();a.value=e,"displayonly"!==t.mode&&e!==t.value&&setTimeout((()=>{n("input",e)}),1)})),{computedValue:a,errorMsg:c}}});const O={class:"prefix"},_={class:"computed-value"},M={class:"suffix"};A.render=function(e,t,r,n,i,l){const u=s("v-input"),a=s("v-notice");return f(),c(d,null,[e.mode?(f(),c("div",{key:0,style:p(e.customCss)},[m("span",O,g(e.prefix),1),m("span",_,g(e.computedValue),1),m("span",M,g(e.suffix),1)],4)):(f(),y(u,v({key:1},e.$attrs,{field:e.field,collection:e.collection,"primary-key":e.primaryKey,"model-value":e.value,"onUpdate:modelValue":t[0]||(t[0]=t=>e.$emit("input",t))}),null,16,["field","collection","primary-key","model-value"])),e.errorMsg?(f(),y(a,{key:2,type:"danger"},{default:S((()=>[T(g(e.errorMsg),1)])),_:1})):E("v-if",!0)],64)},A.__file="src/interface.vue";var C=n({id:"computed",name:"Computed",icon:"calculate",description:"Perform computed value based on other fields",component:A,types:["string","text","integer","decimal","bigInteger","float","boolean","alias"],group:"other",options:[{field:"template",name:"Template",type:"string",meta:{width:"full",interface:"input"}},{field:"mode",name:"Field Mode",type:"string",meta:{width:"full",interface:"select-dropdown",options:{allowNone:!0,choices:[{text:"Display Only",value:"displayonly"},{text:"Read Only",value:"readonly"}]}}},{field:"prefix",name:"Prefix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"suffix",name:"Suffix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"customCss",name:"Custom CSS",type:"json",meta:{width:"full",interface:"input-code",options:{language:"json"}}}]});export{C as default};
